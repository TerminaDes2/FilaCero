generator client {
  provider      = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model roles {
  id_rol     BigInt     @id @default(autoincrement()) @map("id_rol")
  nombre_rol String     @unique @map("nombre_rol") @db.VarChar(50)
  usuarios   usuarios[]

  @@map("roles")
}

model usuarios {
  id_usuario                 BigInt                   @id @default(autoincrement()) @map("id_usuario")
  id_rol                     BigInt?                  @map("id_rol")
  nombre                     String                   @map("nombre") @db.VarChar(150)
  correo_electronico         String                   @unique @map("correo_electronico") @db.VarChar(254)
  password_hash              String                   @map("password_hash") @db.VarChar(255)
  numero_telefono            String?                  @map("numero_telefono") @db.VarChar(30)
  numero_cuenta              String?                  @unique @map("numero_cuenta") @db.VarChar(30)
  fecha_nacimiento           DateTime?                @map("fecha_nacimiento") @db.Date
  fecha_registro             DateTime?                @default(now()) @map("fecha_registro") @db.Timestamptz(6)
  correo_verificado          Boolean                  @default(false) @map("correo_verificado")
  correo_verificado_en       DateTime?                @map("correo_verificado_en") @db.Timestamptz(6)
  sms_verificado             Boolean                  @default(false) @map("sms_verificado")
  sms_verificado_en          DateTime?                @map("sms_verificado_en") @db.Timestamptz(6)
  credencial_verificada      Boolean                  @default(false) @map("credencial_verificada")
  credencial_verificada_en   DateTime?                @map("credencial_verificada_en") @db.Timestamptz(6)
  verification_token         String?                  @unique @map("verification_token") @db.VarChar(128)
  verification_token_expires DateTime?                @map("verification_token_expires") @db.Timestamptz(6)
  avatar_url                 String?                  @map("avatar_url") @db.VarChar(512)
  credential_url             String?                  @map("credential_url") @db.VarChar(512)
  edad                       Int?                     @map("edad") @db.SmallInt
  estado                     String?                  @map("estado") @db.VarChar(20)
  stripe_customer_id         String?                  @unique @map("stripe_customer_id") @db.VarChar(255)
  comentario                 comentario[]
  corte_caja                 corte_caja[]
  empleados                  empleados[]
  feedback                   feedback[]
  movimientos_inventario     movimientos_inventario[]
  negocio                    negocio[]
  negocio_rating             negocio_rating[]
  role                       roles?                   @relation(fields: [id_rol], references: [id_rol], onDelete: NoAction, onUpdate: NoAction)
  venta                      venta[]
  pedidos                    pedido[]
  notificaciones             notificacion[]
  producto_historial_precios producto_historial_precio[]
  usuarios_negocio           usuarios_negocio[]
  metodos_pago               metodo_pago_guardado[]

  @@map("usuarios")
}

model categoria {
  id_categoria BigInt     @id @default(autoincrement())
  nombre       String     @unique @db.VarChar(120)
  producto     producto[]
  negocios     negocio_categoria[]

  @@index([nombre], map: "idx_categoria_nombre")
}

model comentario {
  id_comentario  BigInt      @id @default(autoincrement())
  id_negocio     BigInt      @map("id_negocio")
  id_usuario     BigInt      @map("id_usuario")
  titulo         String?     @map("titulo") @db.VarChar(150)
  contenido      String      @map("comentario") @db.Text
  creado_en      DateTime    @default(now()) @map("fecha") @db.Timestamptz(6)
  actualizado_en DateTime?   @map("actualizado_en") @db.Timestamptz(6)
  estado         String      @default("visible") @map("estado") @db.VarChar(20)
  negocio        negocio     @relation(fields: [id_negocio], references: [id_negocio], onDelete: Cascade, onUpdate: NoAction)
  usuarios       usuarios    @relation(fields: [id_usuario], references: [id_usuario], onDelete: Cascade, onUpdate: NoAction)
  feedback       feedback[]
}

model corte_caja {
  id_corte       BigInt    @id @default(autoincrement())
  id_negocio     BigInt?
  id_usuario     BigInt?
  fecha_inicio   DateTime? @db.Timestamptz(6)
  fecha_fin      DateTime? @db.Timestamptz(6)
  monto_inicial  Decimal?  @db.Decimal(14, 2)
  monto_final    Decimal?  @db.Decimal(14, 2)
  ventas_totales Int?
  negocio        negocio?  @relation(fields: [id_negocio], references: [id_negocio], onDelete: NoAction, onUpdate: NoAction)
  usuarios       usuarios? @relation(fields: [id_usuario], references: [id_usuario], onDelete: NoAction, onUpdate: NoAction)
}

model detalle_venta {
  id_detalle             BigInt                   @id @default(autoincrement())
  id_venta               BigInt?
  id_producto            BigInt?
  cantidad               Int?
  precio_unitario        Decimal?                 @db.Decimal(12, 2)
  producto               producto?                @relation(fields: [id_producto], references: [id_producto], onDelete: NoAction, onUpdate: NoAction)
  venta                  venta?                   @relation(fields: [id_venta], references: [id_venta], onDelete: NoAction, onUpdate: NoAction)
  movimientos_inventario movimientos_inventario[] @relation("DetalleMovimientos")

  @@index([id_producto], map: "idx_detalle_venta_producto")
}

model feedback {
  id_feedback   BigInt      @id @default(autoincrement())
  id_comentario BigInt      @map("id_comentario")
  id_usuario    BigInt      @map("id_usuario")
  tipo          String      @default("like") @map("tipo") @db.VarChar(20)
  mensaje       String?     @map("mensaje")
  calificacion  Int?        @map("calificacion") @db.SmallInt
  creado_en     DateTime    @default(now()) @map("fecha") @db.Timestamptz(6)
  comentario    comentario  @relation(fields: [id_comentario], references: [id_comentario], onDelete: Cascade, onUpdate: NoAction)
  usuarios      usuarios    @relation(fields: [id_usuario], references: [id_usuario], onDelete: Cascade, onUpdate: NoAction)

  @@unique([id_comentario, id_usuario, tipo])
}

model inventario {
  id_inventario       BigInt    @id @default(autoincrement())
  id_negocio          BigInt?
  id_producto         BigInt?
  stock_minimo        Int?      @default(0)
  cantidad_actual     Int?      @default(0)
  fecha_actualizacion DateTime? @db.Timestamptz(6)
  negocio             negocio?  @relation(fields: [id_negocio], references: [id_negocio], onDelete: NoAction, onUpdate: NoAction)
  producto            producto? @relation(fields: [id_producto], references: [id_producto], onDelete: NoAction, onUpdate: NoAction)

  @@unique([id_negocio, id_producto], map: "uq_inventario_negocio_producto")
  @@index([id_negocio], map: "idx_inventario_negocio")
  @@index([id_negocio, id_producto], map: "idx_inventario_negocio_producto")
  @@index([id_producto], map: "idx_inventario_producto")
}

model movimientos_inventario {
  id_movimiento BigInt         @id @default(autoincrement())
  id_negocio    BigInt
  id_producto   BigInt
  delta         Int
  motivo        String         @db.VarChar(50)
  id_venta      BigInt?
  id_detalle    BigInt?
  id_usuario    BigInt?
  fecha         DateTime       @default(now()) @db.Timestamptz(6)
  detalle       detalle_venta? @relation("DetalleMovimientos", fields: [id_detalle], references: [id_detalle])
  negocio       negocio        @relation(fields: [id_negocio], references: [id_negocio])
  producto      producto       @relation(fields: [id_producto], references: [id_producto])
  usuario       usuarios?      @relation(fields: [id_usuario], references: [id_usuario])
  venta         venta?         @relation("VentaMovimientos", fields: [id_venta], references: [id_venta])

  @@index([id_negocio, id_producto, fecha(sort: Desc)], map: "idx_mov_inv_neg_prod_fecha")
  @@map("movimientos_inventario")
}

model negocio {
  id_negocio                  BigInt                        @id @default(autoincrement())
  nombre                      String                        @db.VarChar(200)
  direccion                   String?
  telefono                    String?                       @db.VarChar(30)
  correo                      String?                       @db.VarChar(254)
  logo_url                    String?
  hero_image_url              String?
  fecha_registro              DateTime?                     @default(now()) @db.Timestamptz(6)
  owner_id                    BigInt?                       @map("owner_id") // Due√±o del negocio (FK a usuarios)
  corte_caja                  corte_caja[]
  empleados                   empleados[]
  inventario                  inventario[]
  comentarios                 comentario[]
  movimientos_inventario      movimientos_inventario[]
  usuarios                    usuarios?                     @relation(fields: [owner_id], references: [id_usuario], onDelete: Restrict, map: "fk_negocio_owner")
  negocio_rating              negocio_rating[]
  producto_metricas_semanales producto_metricas_semanales[]
  reporte_ventas              reporte_ventas[]
  venta                       venta[]
  pedidos                     pedido[]
  notificaciones              notificacion[]
  usuarios_negocio            usuarios_negocio[]
  categorias_link             negocio_categoria[]
}

/// This model contains an expression index which requires additional setup for migrations. Visit https://pris.ly/d/expression-indexes for more info.
model producto {
  id_producto                 BigInt                        @id @default(autoincrement())
  id_categoria                BigInt?
  nombre                      String                        @db.VarChar(200)
  descripcion                 String?
  descripcion_larga           String?
  codigo_barras               String?                       @unique @db.VarChar(100)
  precio                      Decimal                       @db.Decimal(12, 2)
  imagen_url                  String?
  estado                      String?                       @db.VarChar(30)
  detalle_venta               detalle_venta[]
  inventario                  inventario[]
  movimientos_inventario      movimientos_inventario[]
  categoria                   categoria?                    @relation(fields: [id_categoria], references: [id_categoria], onDelete: NoAction, onUpdate: NoAction)
  producto_media              producto_media[]
  producto_metricas_semanales producto_metricas_semanales[]
  historial_precios           producto_historial_precio[]
  detalle_pedido              detalle_pedido[]
}

model producto_historial_precio {
  id_historial   BigInt    @id @default(autoincrement())
  id_producto    BigInt
  precio         Decimal   @db.Decimal(12, 2)
  fecha_inicio   DateTime  @default(now()) @db.Timestamptz(6)
  fecha_fin      DateTime? @db.Timestamptz(6)
  vigente        Boolean   @default(true)
  motivo         String?   @db.VarChar(200)
  id_usuario     BigInt?
  creado_en      DateTime  @default(now()) @db.Timestamptz(6)

  producto       producto  @relation(fields: [id_producto], references: [id_producto], onDelete: Cascade)
  usuario        usuarios? @relation(fields: [id_usuario], references: [id_usuario], onDelete: SetNull)

  @@index([id_producto, vigente])
  @@index([id_producto, fecha_inicio])
  @@map("producto_historial_precio")
}

model reporte_ventas {
  id_reporte          BigInt    @id @default(autoincrement())
  id_negocio          BigInt?
  fecha               DateTime? @db.Date
  total_ventas        Decimal?  @db.Decimal(14, 2)
  total_productos     Int?
  total_efectivo      Decimal?  @db.Decimal(14, 2)
  total_tarjeta       Decimal?  @db.Decimal(14, 2)
  total_transferencia Decimal?  @db.Decimal(14, 2)
  negocio             negocio?  @relation(fields: [id_negocio], references: [id_negocio], onDelete: NoAction, onUpdate: NoAction)
}

model tipo_pago {
  id_tipo_pago BigInt   @id @default(autoincrement())
  tipo         String   @unique @db.VarChar(50)
  descripcion  String?
  venta        venta[]
  pedidos      pedido[]
}

model venta {
  id_venta               BigInt                   @id @default(autoincrement())
  id_negocio             BigInt?
  id_usuario             BigInt?
  fecha_venta            DateTime?                @db.Timestamptz(6)
  total                  Decimal?                 @db.Decimal(14, 2)
  id_tipo_pago           BigInt?
  estado                 String?                  @db.VarChar(30)
  detalle_venta          detalle_venta[]
  movimientos_inventario movimientos_inventario[] @relation("VentaMovimientos")
  negocio                negocio?                 @relation(fields: [id_negocio], references: [id_negocio], onDelete: NoAction, onUpdate: NoAction)
  tipo_pago              tipo_pago?               @relation(fields: [id_tipo_pago], references: [id_tipo_pago], onDelete: NoAction, onUpdate: NoAction)
  usuarios               usuarios?                @relation(fields: [id_usuario], references: [id_usuario], onDelete: NoAction, onUpdate: NoAction)

  @@index([fecha_venta], map: "idx_venta_fecha")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model empleados {
  id_empleado BigInt   @id @default(autoincrement())
  negocio_id  BigInt
  usuario_id  BigInt
  estado      String   @default("activo") @db.VarChar(20)
  fecha_alta  DateTime @default(now()) @db.Timestamptz(6)
  negocio     negocio  @relation(fields: [negocio_id], references: [id_negocio])
  usuarios    usuarios @relation(fields: [usuario_id], references: [id_usuario])

  @@unique([negocio_id, usuario_id], map: "uq_empleados_negocio_usuario")
}

model negocio_rating {
  id_rating  BigInt   @id @default(autoincrement())
  id_negocio BigInt
  id_usuario BigInt
  estrellas  Int      @db.SmallInt
  comentario String?
  creado_en  DateTime @default(now()) @db.Timestamptz(6)
  negocio    negocio  @relation(fields: [id_negocio], references: [id_negocio], onDelete: Cascade, onUpdate: NoAction)
  usuarios   usuarios @relation(fields: [id_usuario], references: [id_usuario], onDelete: Cascade, onUpdate: NoAction)

  @@unique([id_negocio, id_usuario])
}

model producto_media {
  id_media    BigInt   @id @default(autoincrement())
  id_producto BigInt
  url         String   @db.VarChar(2048)
  principal   Boolean  @default(false)
  tipo        String?  @db.VarChar(30)
  creado_en   DateTime @default(now()) @db.Timestamptz(6)
  producto    producto @relation(fields: [id_producto], references: [id_producto], onDelete: Cascade, onUpdate: NoAction)
}

model producto_metricas_semanales {
  id_metricas  BigInt   @id @default(autoincrement())
  id_producto  BigInt
  id_negocio   BigInt?
  anio         Int
  semana       Int
  cantidad     Int
  calculado_en DateTime @default(now()) @db.Timestamptz(6)
  negocio      negocio? @relation(fields: [id_negocio], references: [id_negocio], onDelete: Cascade, onUpdate: NoAction)
  producto     producto @relation(fields: [id_producto], references: [id_producto], onDelete: Cascade, onUpdate: NoAction)

  @@unique([id_producto, id_negocio, anio, semana])
}

model pedido {
  id_pedido            BigInt            @id @default(autoincrement())
  id_negocio           BigInt
  id_usuario           BigInt?
  id_tipo_pago         BigInt?
  estado               String            @default("pendiente") @db.VarChar(30)
  fecha_creacion       DateTime          @default(now()) @db.Timestamptz(6)
  fecha_confirmacion   DateTime?         @db.Timestamptz(6)
  fecha_preparacion    DateTime?         @db.Timestamptz(6)
  fecha_listo          DateTime?         @db.Timestamptz(6)
  fecha_entrega        DateTime?         @db.Timestamptz(6)
  total                Decimal           @db.Decimal(14, 2)
  notas_cliente        String?           @db.Text
  tiempo_entrega       String?           @db.VarChar(50)
  nombre_cliente       String?           @db.VarChar(100)
  email_cliente        String?           @db.VarChar(100)
  telefono_cliente     String?           @db.VarChar(20)
  creado_en            DateTime          @default(now()) @db.Timestamptz(6)
  actualizado_en       DateTime          @updatedAt @db.Timestamptz(6)
  detalle_pedido       detalle_pedido[]
  notificaciones       notificacion[]
  transacciones        transaccion_pago[]
  negocio              negocio           @relation(fields: [id_negocio], references: [id_negocio], onDelete: Cascade)
  usuario              usuarios?         @relation(fields: [id_usuario], references: [id_usuario], onDelete: SetNull)
  tipo_pago            tipo_pago?        @relation(fields: [id_tipo_pago], references: [id_tipo_pago])

  @@index([id_negocio, estado])
  @@index([id_usuario])
  @@index([fecha_creacion])
  @@map("pedido")
}

model metodo_pago_guardado {
  id_metodo              BigInt    @id @default(autoincrement())
  id_usuario             BigInt
  stripe_payment_method  String    @unique @map("stripe_payment_method_id") @db.VarChar(255)
  stripe_customer_id     String    @map("stripe_customer_id") @db.VarChar(255)
  tipo                   String    @db.VarChar(20)
  marca                  String?   @db.VarChar(20)
  ultima_4_digitos       String    @db.VarChar(4)
  mes_expiracion         Int?
  anio_expiracion        Int?
  nombre_tarjeta         String?   @db.VarChar(100)
  is_default             Boolean   @default(false)
  activo                 Boolean   @default(true)
  creado_en              DateTime  @default(now()) @db.Timestamptz(6)
  actualizado_en         DateTime  @updatedAt @db.Timestamptz(6)
  usuario                usuarios  @relation(fields: [id_usuario], references: [id_usuario], onDelete: Cascade)

  @@index([id_usuario, activo])
  @@index([stripe_customer_id])
  @@map("metodo_pago_guardado")
}

model transaccion_pago {
  id_transaccion      BigInt    @id @default(autoincrement())
  id_pedido           BigInt
  stripe_payment_id   String?   @unique @db.VarChar(255)
  stripe_customer_id  String?   @db.VarChar(255)
  monto               Decimal   @db.Decimal(12, 2)
  moneda              String    @default("mxn") @db.VarChar(3)
  estado              String    @default("pending") @db.VarChar(30)
  metodo_pago         String    @db.VarChar(50)
  ultima_4_digitos    String?   @db.VarChar(4)
  marca_tarjeta       String?   @db.VarChar(20)
  tipo_tarjeta        String?   @db.VarChar(20)
  error_codigo        String?   @db.VarChar(50)
  error_mensaje       String?   @db.Text
  metadata            Json?
  stripe_fee          Decimal?  @db.Decimal(12, 2)
  net_amount          Decimal?  @db.Decimal(12, 2)
  refund_id           String?   @db.VarChar(255)
  refunded_at         DateTime? @db.Timestamptz(6)
  creado_en           DateTime  @default(now()) @db.Timestamptz(6)
  actualizado_en      DateTime  @updatedAt @db.Timestamptz(6)
  pedido              pedido    @relation(fields: [id_pedido], references: [id_pedido], onDelete: Cascade)

  @@index([id_pedido])
  @@index([estado])
  @@index([creado_en])
  @@map("transaccion_pago")
}

model detalle_pedido {
  id_detalle      BigInt   @id @default(autoincrement())
  id_pedido       BigInt
  id_producto     BigInt
  cantidad        Int
  precio_unitario Decimal  @db.Decimal(10, 2)
  notas           String?  @db.Text
  pedido          pedido   @relation(fields: [id_pedido], references: [id_pedido], onDelete: Cascade)
  producto        producto @relation(fields: [id_producto], references: [id_producto])

  @@index([id_pedido])
  @@map("detalle_pedido")
}

model notificacion {
  id_notificacion BigInt    @id @default(autoincrement())
  id_usuario      BigInt?
  id_negocio      BigInt?
  id_pedido       BigInt?
  tipo            String    @db.VarChar(30)
  titulo          String    @db.VarChar(200)
  mensaje         String    @db.Text
  leida           Boolean   @default(false)
  canal           String?   @db.VarChar(20)
  enviada_en      DateTime? @db.Timestamptz(6)
  leida_en        DateTime? @db.Timestamptz(6)
  creado_en       DateTime  @default(now()) @db.Timestamptz(6)
  usuario         usuarios? @relation(fields: [id_usuario], references: [id_usuario], onDelete: Cascade)
  negocio         negocio?  @relation(fields: [id_negocio], references: [id_negocio], onDelete: Cascade)
  pedido          pedido?   @relation(fields: [id_pedido], references: [id_pedido], onDelete: Cascade)

  @@index([id_usuario, leida])
  @@index([id_negocio, tipo])
  @@index([creado_en])
  @@map("notificacion")
}

model usuarios_negocio {
  id_asignacion    BigInt    @id @default(autoincrement())
  id_usuario       BigInt
  id_negocio       BigInt
  rol              String    @db.VarChar(30)
  fecha_asignacion DateTime? @db.Timestamptz(6)
  usuario          usuarios  @relation(fields: [id_usuario], references: [id_usuario], onDelete: Cascade)
  negocio          negocio   @relation(fields: [id_negocio], references: [id_negocio], onDelete: Cascade)

  @@unique([id_usuario, id_negocio])
  @@map("usuarios_negocio")
}

model negocio_categoria {
  id_asignacion BigInt    @id @default(autoincrement())
  id_negocio    BigInt
  id_categoria  BigInt
  negocio       negocio   @relation(fields: [id_negocio], references: [id_negocio], onDelete: Cascade)
  categoria     categoria @relation(fields: [id_categoria], references: [id_categoria], onDelete: Cascade)

  @@unique([id_negocio, id_categoria])
  @@map("negocio_categoria")
}
